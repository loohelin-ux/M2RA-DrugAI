# 多模态反应-活性图（RAG）理论与M²RA-GNN模型

## 1. 研究背景与问题定义

传统药物研发流程中，分子设计（关注生物活性）与合成优化（关注反应可行性）通常被割裂建模，导致"高活性但难合成"的无效设计频繁出现。核心问题在于：
- 分子结构、反应条件、靶点信息、活性数据等多模态科学数据缺乏统一表示框架；
- 化学反应的"转化规律"与分子-靶点的"作用规律"难以协同学习；
- 多目标优化（活性最大化+产率最大化）缺乏闭环反馈机制。

本理论提出**反应-活性图（Reaction-Activity Graph, RAG）** 与**多模态反应-活性图神经网络（M²RA-GNN）**，通过统一建模与协同优化解决上述问题。


## 2. 反应-活性图（RAG）的形式化定义

### 2.1 图结构定义

RAG是一个异构有向图，形式化为 $G = (V, E, \tau, \rho)$，其中：
- $V$：节点集合，包含5类核心节点：
  - 分子节点（$v_m$）：表示化学分子（SMILES格式），包含原子级微观特征与分子量等宏观特征；
  - 反应节点（$v_r$）：表示化学反应（如A+B→C），包含反应类型、催化剂等元信息；
  - 条件节点（$v_c$）：表示反应条件（温度、溶剂、压力等）；
  - 靶点节点（$v_t$）：表示生物靶点（如蛋白质序列）；
  - 活性节点（$v_a$）：表示分子-靶点的活性值（如IC50、EC50）。

- $E$：边集合，包含4类核心边（描述节点间关系）：
  - 参与边（$e_{m \rightarrow r}$）：分子→反应（表示分子参与反应）；
  - 调控边（$e_{c \rightarrow r}$）：条件→反应（表示条件调控反应）；
  - 生成边（$e_{r \rightarrow m}$）：反应→分子（表示反应生成产物）；
  - 作用边（$e_{m \rightarrow t \rightarrow a}$）：分子→靶点→活性（表示分子与靶点结合产生活性）。

- $\tau: V \rightarrow T_V$：节点类型映射（$T_V = \{m, r, c, t, a\}$）；
- $\rho: E \rightarrow T_E$：边类型映射（$T_E = \{m \rightarrow r, c \rightarrow r, r \rightarrow m, m \rightarrow t, t \rightarrow a\}$）。


### 2.2 层次化特征表示

RAG的节点特征采用"微观-宏观"双层表示：
- **微观特征**：分子节点包含原子坐标、化学键类型等原子级信息（通过RDKit提取）；
- **宏观特征**：
  - 分子节点：分子量、拓扑指纹、脂水分配系数（LogP）等；
  - 反应节点：反应中心原子类型、原子转移数等；
  - 条件节点：温度归一化值、溶剂极性参数等；
  - 靶点节点：氨基酸序列嵌入、二级结构特征等；
  - 活性节点：实验测定的活性值（归一化到[0,1]区间）。


## 3. M²RA-GNN模型架构

### 3.1 整体框架

M²RA-GNN是专为RAG设计的异构图神经网络，核心是**边类型专属的消息传递机制**，实现多模态信息的协同学习。模型架构分为3部分：
1. 特征编码层：将节点的原始特征映射到统一维度的嵌入空间；
2. 异构消息传递层：针对不同边类型设计专属消息函数，实现跨模态信息融合；
3. 多任务预测层：同时预测反应产率（针对反应节点）与分子活性（针对活性节点）。


### 3.2 边类型专属消息函数

针对RAG的4类核心边，设计差异化消息函数 $\phi_r$（$r$ 为边类型）：

#### （1）参与边（$m \rightarrow r$）：分子→反应
$$
\phi_{m \rightarrow r}(h_m, h_r) = \sigma(W_1 \cdot [h_m \| h_r] + b_1)
$$
其中 $h_m$ 为分子节点嵌入，$h_r$ 为反应节点嵌入，$\sigma$ 为ReLU激活函数，$\|$ 表示特征拼接，$W_1, b_1$ 为可学习参数。

#### （2）调控边（$c \rightarrow r$）：条件→反应
$$
\phi_{c \rightarrow r}(h_c, h_r) = \text{GAT}(h_c, h_r, e_{c \rightarrow r})
$$
采用图注意力机制（GAT），为不同条件分配注意力权重（如温度对反应的影响权重高于溶剂）。

#### （3）生成边（$r \rightarrow m$）：反应→产物
$$
\phi_{r \rightarrow m}(h_r, h_m) = \text{EQGAT}(h_r, h_m, \text{pos}_m)
$$
引入等变图注意力（EQGAT），融合产物分子的3D坐标 $\text{pos}_m$，捕捉空间结构对产物稳定性的影响。

#### （4）作用边（$m \rightarrow t$）：分子→靶点
$$
\phi_{m \rightarrow t}(h_m, h_t) = \text{MLP}([h_m \odot h_t])
$$
通过元素积（$\odot$）计算分子与靶点的互补性，再通过MLP输出结合强度特征。


### 3.3 多任务损失函数

模型采用联合损失函数，同时优化产率预测与活性预测：
$$
\mathcal{L} = \lambda_1 \cdot \mathcal{L}_{\text{yield}} + \lambda_2 \cdot \mathcal{L}_{\text{activity}}
$$
- $\mathcal{L}_{\text{yield}} = \text{MSE}(\hat{y}_{\text{yield}}, y_{\text{yield}})$：产率预测的均方误差；
- $\mathcal{L}_{\text{activity}} = \text{MSE}(\hat{y}_{\text{activity}}, y_{\text{activity}})$：活性预测的均方误差；
- $\lambda_1, \lambda_2$ 为权重系数（默认 $\lambda_1=0.4, \lambda_2=0.6$，平衡合成与活性重要性）。


## 4. 双重闭环贝叶斯优化策略

基于M²RA-GNN的预测能力，设计"外循环-内循环"双重闭环优化：

### 4.1 外循环（分子发现）
目标：筛选"高活性且易合成"的候选分子。
- 搜索空间：分子结构参数（如环数、官能团类型、分子量范围）；
- 评分函数：$S(m) = \alpha \cdot \hat{y}_{\text{activity}}(m) + (1-\alpha) \cdot (1 - \text{uncertainty}_{\text{yield}}(m))$，其中 $\alpha=0.7$ 为活性权重，$\text{uncertainty}_{\text{yield}}$ 为合成不确定性（越低越易合成）。

### 4.2 内循环（合成优化）
目标：为外循环筛选的分子优化反应条件，最大化产率。
- 搜索空间：反应条件参数（温度：20-150℃，溶剂：水/DMSO/乙醇等）；
- 优化算法：贝叶斯优化（高斯过程作为代理模型，期望改进EI为采集函数）。

### 4.3 闭环迭代流程
1. 初始化：用少量实验数据训练M²RA-GNN；
2. 外循环推荐候选分子；
3. 内循环为候选分子优化反应条件；
4. 执行实验，获取真实产率与活性；
5. 用新数据更新模型，返回步骤2迭代。


## 5. 理论创新点总结

1. **统一表示理论**：首次将分子、反应、条件、靶点、活性编码为RAG，打破多模态数据壁垒；
2. **异构消息传递**：为不同边类型设计专属消息函数，特别是EQGAT层融合3D几何信息；
3. **双重闭环优化**：协同优化分子活性与合成产率，减少无效实验次数。
